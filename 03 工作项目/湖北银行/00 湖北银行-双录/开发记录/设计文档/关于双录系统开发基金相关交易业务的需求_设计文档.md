#                   基金业务双录流程技术方案

## 需求理解

> **需求描述：** 为完善理财专区内销售行为的合规性,现申请在智能双录系统中新增基金风险评估双录和基金购买双录业务流程。

**涉及功能点：**

* 功能点1：智能双录系统中新增基金风险评估双录

* 功能点2：智能双录系统种新增基金购买双录

## 方案设计

### 整体架构设计

> 说明：
>
> 1. 与基金系统的接口交互，通过esb进行。
> 2. 基金双录的视频文件，通过音视频集群上传到音像平台。
> 3. 流水数据通过双录系统的后端服务保存到mysql数据库。

```mermaid
graph LR
    %% 用户访问路径
    subgraph "用户访问路径"
        A[Web前端] --> D[F5] --> E[Nginx] --> B[后端服务]
    end
    
    %% 音视频
    subgraph "音视频"
        A --> F[音视频集群]
    end
    
    %% 后端依赖
    subgraph "后端数据依赖"
        B --> H[(MySQL)]
        B --> C[影像平台]
        B --> F
    end
    
    %% 外部系统调用
    subgraph "外部系统调用链"
        B --> I[ESB] --> J[基金系统]
    end
    
    %% 样式
    style A fill:#e3f2fd
    style D fill:#c8e6c9
    style E fill:#c8e6c9
    style B fill:#bbdefb
    style H fill:#fff9c4
    style C fill:#fff9c4
    style F fill:#d1c4e9
    style I fill:#ffccbc
    style J fill:#ffcc80
```

### 详细架构设计

> 详细展示了客户经理从开始输入银行卡号查询用户信息，到提交双录业务，然后客户经理质检流水通过后，最后被基金系统消费、关联流水的全过程。

```mermaid
sequenceDiagram
    box whitesmoke 用户
    participant C as 客户经理
    end
    box honeydew 临柜智能双录系统
    participant A as 双录前端
    participant B as 双录后端
    end
    box gainsboro AnyChat音视频集群
    participant F as 集群
    end
    box beige ESB
    participant G as esb
    end
    box beige 第三方\外部系统
    participant D as 基金系统
    participant E as 核心系统
    end
    autonumber
    
    C->>+A: 输入银行卡号，点击查询
    A->>+B: 查询客户信息
    B->>+G: 查询客户信息
    G->>+E: 查询客户信息
    E->>-G: 返回用户查询结果
    G->>-B: 返回用户查询结果
    B->>-A: 返回用户查询结果
    
    C->>C: 点击下一步
    C->>C: 选择业务类型、播报速度
    C->>A: 点击下一步
    
    A->>+B: 校验客户风评的次数
    B->>+G: 校验客户风评的次数
    G->>+D: 校验客户风评的次数
    D-->>-G: 返回风评次数的结果
    G-->>-B: 返回风评次数的结果
    
    rect rgb(240, 240, 240)
        Note over B: 风评校验结果处理
        alt 阻塞流程
            B-->>A: 返回风评次数超限
        else 状态正常,继续双录
            B-->>A: 返回风评次数正常
        end
    end
    
    C->>A: 选择产品
    A->>+B: 查询产品信息
    B-->>-A: 返回产品查询结果
    
    C->>C: 勾选产品<br>点击下一步
    C->>C: 输入购买金额<br>点击下一步
    
    A->>A: 初始化SDK
    A->>+F: 连接、登录集群
    F-->>-A: 返回连接、登录状态信息
    
    A->>+B: 添加流水号信息
    B-->>-A: 返回添加流水号的结果
    
    A->>+B: 查询质检条目
    B-->>-A: 返回查询质检条目结果
    
    A->>+B: 查询质检规则
    B-->>-A: 返回质检结果
    
    A->>+B: 校验客户经理信息
    B->>+G: 校验客户经理信息
    G->>+D: 校验客户经理信息
    D->>-G: 返回校验的结果
    G->>-B: 返回校验的结果
    rect rgb(240, 240, 240)
        Note over B: 校验客户经理的结果处理
        alt 阻塞流程
            B-->>A: 客户经理信息异常
        else 状态正常,继续双录
            B-->>A: 客户经理信息正常
        end
    end
    A->>A: 开始双录、播放话术
    
    A->>+B: 查询风评问卷题目
    B->>+G: 查询风评问卷题目
    G->>+D: 查询风评问卷题目
    D->>-G: 返回题目数据
    G->>-B: 返回题目数据
    B->>-A: 返回题目数据
   
    C->>C: 填写问卷
    C->>C: 点击下一步
    C->>A: 风评结果预测
    A->>+B: 风评结果预测
    B->>+G: 风评结果预测
    G->>+D: 风评结果预测
    D->>-G: 返回预测结果
    G->>-B: 返回预测结果
    B->>-A: 返回预测结果
    C->>C: 进行相关资料的拍照
    C->>A: 提交业务、保存视频
    
    A->>+F: 提交业务
    F->>-A: 返回提交的状态
    
    A->>+B: 更新流水信息
    B->>-A: 返回更新状态，结束双录
    
    C->>A: 质检通过
    A->>+B: 更新流水
    B->>-A: 返回更新状态
    
    D->>+G: 查询购买基金需要关联的双录流水
    G->>+B: 查询购买基金需要关联的双录流水
    B->>-G: 返回基金购买需要关联的流水
    G->>-D: 返回基金购买需要关联的流水
```

### 接口设计

**新增接口清单：**

| 交易名称                                               | 交互类型                                     | 调用方式                                 | 系统交互关系                                                 |
| :----------------------------------------------------- | :------------------------------------------- | :--------------------------------------- | :----------------------------------------------------------- |
| 客户购买基金产品资格校验                               | 新增接口                                     | ESB                                      | 智能双录系统 → 银保通系统                                    |
| 客户经理信息校验                                       | 新增接口                                     | ESB                                      | 智能双录系统 → 银保通系统                                    |
| <span style="color:#CC0000;">客户反洗钱信息校验</span> | <span style="color:#CC0000;">新增接口</span> | <span style="color:#CC0000;">ESB </span> | <span style="color:#CC0000;">智能双录系统 → 银保通系统</span> |
| 客户风评次数校验                                       | 新增接口                                     | ESB                                      | 智能双录系统 → 银保通系统                                    |
| 查询风险题目                                           | 新增接口                                     | ESB                                      | 智能双录系统 → 银保通系统                                    |
| 风评结果预测                                           | 新增接口                                     | ESB                                      | 智能双录系统 → 银保通系统                                    |
| 提交风险评估                                           | 新增接口                                     | ESB                                      | 智能双录系统 → 银保通系统                                    |
| 接受交易系统成功通知                                   | 修订接口                                     | ESB                                      | 银保通系统 → 智能双录系统                                    |

## 核心实现

### 关键类设计

```java
com.bairuitech.anychat.gateway
├── controller/                           # 控制器层
│   └── EsbPublicController.java
├── service/                              # 服务接口层
│   └── EsbPublicService.java
├── service/impl/                         # 服务实现层
│   └── EsbPublicServiceImpl.java
```

### 技术要点

* **异常处理：** 统一异常处理器
* **日志记录：** 关键操作记录审计日志

## 代码规范

1. **命名规范：** 遵循公司命名规范
2. **注释要求：** 复杂逻辑需添加注释
3. **日志规范：** 使用LOG4J，关键操作记录INFO日志
4. **异常处理：** 使用自定义业务异常
