<%*
// 年记专属配置（彻底修复语法错误 + 规范命名）
const now = new Date();
const config = {
  rootFolder: `01 日常笔记/${tp.date.now("YYYY")}`, // 修复：tp.date.now 无多余空格、大小写正确
  year: tp.date.now("YYYY"),
  focus: await tp.system.prompt("本年度核心主题（可选）", ""),
  author: tp.frontmatter?.author || tp.config?.user_name || "自己",
  fileName: `年记-${tp.date.now("YYYY")}.md`
};

// 自动创建文件夹（增加前置校验 + 兼容空路径）
const createFolder = async (path) => {
  // 新增：空路径校验，避免无效调用
  if (!path || path.trim() === "") {
    new Notice(`❌ 文件夹路径不能为空`, 3000);
    return false;
  }
  
  try {
    const folder = app.vault.getAbstractFileByPath(path);
    if (!folder) {
      await app.vault.createFolder(path);
      new Notice(`📁 已创建文件夹：${path}`, 1000);
    }
    return true;
  } catch (error) {
    new Notice(`❌ 创建文件夹失败：${error.message}`, 5000);
    return false;
  }
};

// 先校验根文件夹创建结果，失败则终止
const folderCreated = await createFolder(config.rootFolder);
if (!folderCreated) {
  return;
}

// 文件完整路径
const fullPath = `${config.rootFolder}/${config.fileName}`;

// 防止重复创建（增加文件类型校验，避免文件夹重名干扰）
const existingFile = app.vault.getAbstractFileByPath(fullPath);
if (existingFile && existingFile instanceof TFile) {
  new Notice(`⚠️ ${config.year} 年度总结已存在！`, 3000);
  return;
}

// 年记内容模板（彻底清理注释语法错误 + 优化格式）
const content = `---
title: 年度总结 - ${config.year}
date: ${tp.date.now("YYYY-MM-DD HH:mm:ss")}
author: ${config.author}
type: yearly
focus: ${config.focus || "无"}
tags: [日志, 年记, ${config.year}年]
---

# 🎯 年度总结 | ${config.year}
## 一、年度关键词
- 核心：
- 成长：
- 遗憾：

## 二、年度目标完成复盘
| 维度 | 年初目标 | 年末结果 | 完成度 | 核心原因 |
|------|----------|----------|--------|----------|
| 事业/工作 |          |          |        |          |
| 学习/技能 |          |          |        |          |
| 财务/理财 |          |          |        |          |
| 健康/生活 |          |          |        |          |
| 人际关系 |          |          |        |          |
| 自我成长 |          |          |        |          |

## 三、年度关键事件（按时间线）
1. 
2. 
3. 
4. 
5. 

## 四、年度收获与成长
### 📚 能力提升
- 
- 

### 💡 认知升级
- 
- 

### 🧠 心态变化
- 

## 五、年度遗憾与不足
- 
- 

## 六、下一年度规划
### 年度核心主题：
### 分维度目标：
- 事业/工作：
- 学习/成长：
- 生活/健康：
- 财务/理财：
- 人际关系：

### 季度关键行动计划
| 季度 | 核心任务 | 里程碑 | 资源需求 |
|------|----------|--------|----------|
| Q1   |          |        |          |
| Q2   |          |        |          |
| Q3   |          |        |          |
| Q4   |          |        |          |

## 七、写给自己的话
- 
`;

// 修复：改用更稳定的 app.vault.create 方法（兼容所有Templater版本）
try {
  await app.vault.create(fullPath, content);
  const newFile = app.vault.getAbstractFileByPath(fullPath);
  if (newFile) {
    await app.workspace.getLeaf(true).openFile(newFile);
    new Notice(`✅ ${config.year} 年度总结已生成并打开！`, 2000);
  } else {
    new Notice(`⚠️ 年度总结已创建，但无法自动打开`, 2000);
  }
} catch (createError) {
  new Notice(`❌ 生成年度总结失败：${createError.message}`, 5000);
}
%>