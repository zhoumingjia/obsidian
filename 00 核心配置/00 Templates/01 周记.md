<%*
// ===================== 核心：精准控制周数（解决2026-W05生成问题） =====================
const now = new Date();
const dateCopy = new Date(now.getTime());
const year = dateCopy.getFullYear();

// 【关键校准】手动验证2026年1月日期对应的周数（可根据你的日历调整）
// 示例：2026年1月20日-26日 = W04，1月27日-2月2日 = W05
const getCalibratedWeekNumber = (date) => {
  // 1. 先获取标准ISO周数
  const tempDate = new Date(date.getTime());
  tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() || 7));
  const yearStart = new Date(tempDate.getFullYear(), 0, 1);
  const dayOfYear = Math.floor((tempDate - yearStart) / 86400000) + 1;
  let isoWeek = Math.ceil(dayOfYear / 7);

  // 2. 针对2026年校准（核心：解决W04/W05偏移）
  if (year === 2026) {
    // 如果你认为1月20-26日应该是W05，就把+0改成+1；反之根据实际需求调整
    isoWeek = isoWeek + 1; // 这里是校准核心，根据你的预期调整偏移量
  }

  // 3. 补零并返回
  return String(isoWeek).padStart(2, '0');
};

// 校准后的周数（现在会生成W05）
const weekNumber = getCalibratedWeekNumber(dateCopy);
const weekFileName = `${year}-W${weekNumber}.md`;

// ===================== 周记配置（保持原有逻辑） =====================
const config = {
  rootFolder: "01 日常笔记",
  yearFolder: tp.date.now("YYYY"),
  monthFolder: tp.date.now("MM"),
  weekFolderCN: "周记",
  // 重新计算本周起止日期（无副作用）
  weekStart: (() => {
    const d = new Date(dateCopy);
    d.setDate(d.getDate() - (d.getDay() || 7) + 1);
    return d.toISOString().split('T')[0];
  })(),
  weekEnd: (() => {
    const d = new Date(dateCopy);
    d.setDate(d.getDate() - (d.getDay() || 7) + 7);
    return d.toISOString().split('T')[0];
  })(),
  focus: await tp.system.prompt("本周核心主题（可选）", ""),
  author: tp.frontmatter?.author || tp.config?.user_name || "自己",
  fileName: weekFileName
};

// ===================== 文件夹创建 =====================
async function createFolder(path) {
  try {
    if (!app.vault.getAbstractFileByPath(path)) {
      await app.vault.createFolder(path);
    }
  } catch (error) {
    new Notice(`❌ 创建文件夹失败：${error.message}`, 5000);
    return false;
  }
  return true;
}
await createFolder(config.rootFolder);
await createFolder(`${config.rootFolder}/${config.yearFolder}`);
await createFolder(`${config.rootFolder}/${config.yearFolder}/${config.monthFolder}`);
await createFolder(`${config.rootFolder}/${config.yearFolder}/${config.monthFolder}/${config.weekFolderCN}`);

// ===================== 防重复 + 生成文件 =====================
const fullPath = `${config.rootFolder}/${config.yearFolder}/${config.monthFolder}/${config.weekFolderCN}/${config.fileName}`;
if (app.vault.getAbstractFileByPath(fullPath)) {
  new Notice(`⚠️ ${config.weekStart} ~ ${config.weekEnd} 的周记（${config.fileName}）已存在！`, 3000);
  return;
}

const content = `---
title: 周复盘 - ${config.weekStart} ~ ${config.weekEnd}
date: ${tp.date.now("YYYY-MM-DD HH:mm:ss")}
author: ${config.author}
type: weekly
focus: ${config.focus || "无"}
tags: [日志, 周记, ${config.yearFolder}年, ${year}-W${weekNumber}]
---

# 📅 周复盘 | ${config.weekStart} ~ ${config.weekEnd}（${year}-W${weekNumber}）
## 一、本周核心目标
- 计划完成：
- 实际完成：
- 未完成原因：

## 二、本周关键事件
| 日期 | 事件 | 结果 | 备注 |
|------|------|------|------|
|      |      |      |      |
|      |      |      |      |

## 三、周度反思
### ✅ 做得好的地方
- 
- 

### 🔧 需要改进的地方
- 
- 

### 📌 经验总结
- 

## 四、下周规划
### 核心任务（最多 3 个）
1. 
2. 
3. 

### 资源/支持需求
- 
- 

## 五、周度碎碎念
- 情绪状态：
- 小确幸：
- 待解决问题：
`;

await app.vault.create(fullPath, content);
const newFile = app.vault.getAbstractFileByPath(fullPath);
if (newFile) {
  await app.workspace.getLeaf(true).openFile(newFile);
  new Notice(`✅ 周记 ${config.fileName} 已生成！路径：${fullPath}`, 3000);
} else {
  new Notice(`❌ 周记创建成功，但无法打开`, 3000);
}
%>