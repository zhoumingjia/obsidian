<%*
// 月记专属配置（兼容所有Templater版本）
const now = new Date();
const year = now.getFullYear();
const month = now.getMonth(); // 0-11，0代表1月，11代表12月

// 计算当月第一天（当月1号）
const monthStartDate = new Date(year, month, 1);
// 计算当月最后一天（下个月1号减1天）
const monthEndDate = new Date(year, month + 1, 0);

// 格式化日期为 YYYY-MM-DD 格式
const formatDate = (date) => {
  return date.toISOString().split('T')[0];
};

// 配置项（保持和周记一致的风格，适配月度场景）
const config = {
  rootFolder: "01 日常笔记", // 与周记共用根目录
  yearFolder: tp.date.now("YYYY"),
  monthFolder: tp.date.now("MM"), // 月份文件夹（01-12）
  monthStart: formatDate(monthStartDate), // 当月第一天（YYYY-MM-DD）
  monthEnd: formatDate(monthEndDate),     // 当月最后一天（YYYY-MM-DD）
  focus: await tp.system.prompt("本月核心主题（可选）", ""),
  author: tp.frontmatter?.author || tp.config?.user_name || "自己",
  // 格式化文件名（如：月记-202601.md）
  fileName: `月记-${tp.date.now("YYYYMM")}.md`
};

// 自动创建文件夹（稳定写法 + 异常捕获）
async function createFolder(path) {
  try {
    if (!app.vault.getAbstractFileByPath(path)) {
      await app.vault.createFolder(path);
    }
  } catch (error) {
    new Notice(`❌ 创建文件夹失败：${error.message}`, 5000);
    return false;
  }
  return true;
}

// 按层级创建文件夹（根→年→月），和周记共用目录结构
await createFolder(config.rootFolder);
await createFolder(`${config.rootFolder}/${config.yearFolder}`);
await createFolder(`${config.rootFolder}/${config.yearFolder}/${config.monthFolder}`);

// 文件完整路径
const fullPath = `${config.rootFolder}/${config.yearFolder}/${config.monthFolder}/${config.fileName}`;

// 防止重复创建月记
if (app.vault.getAbstractFileByPath(fullPath)) {
  new Notice(`⚠️ ${config.monthStart} ~ ${config.monthEnd} 的月记已存在！`, 3000);
  return;
}

// 月记内容模板（适配月度复盘的深度和广度）
const content = `---
title: 月复盘 - ${config.monthStart} ~ ${config.monthEnd}
date: ${tp.date.now("YYYY-MM-DD HH:mm:ss")}
author: ${config.author}
type: monthly
focus: ${config.focus || "无"}
tags: [日志, 月记, ${config.yearFolder}年]
---

# 📅 月复盘 | ${config.monthStart} ~ ${config.monthEnd}
## 一、本月核心目标
### 月度计划
- 
- 
- 

### 完成情况
| 目标 | 完成度(%) | 成果说明 | 未完成原因 |
|------|-----------|----------|------------|
|      |           |          |            |
|      |           |          |            |

## 二、本月关键成果
### 核心业绩/成果
- 
- 

### 里程碑事件
1. 
2. 
3. 

## 三、月度深度反思
### ✅ 做得好的地方
- 
- 

### 🔧 需要改进的地方
- 
- 

### 🚫 本月踩坑记录
| 问题 | 发生场景 | 解决方案 | 避免措施 |
|------|----------|----------|----------|
|      |          |          |          |
|      |          |          |          |

### 📌 月度经验沉淀
- 
- 

## 四、下月规划
### 核心目标（最多 3 个）
1. 
2. 
3. 

### 关键行动计划
| 任务 | 负责人 | 截止日期 | 所需资源 | 预期成果 |
|------|--------|----------|----------|----------|
|      |        |          |          |          |
|      |        |          |          |          |

### 风险预判与应对
- 潜在风险：
- 应对措施：

## 五、月度总结
### 个人成长
- 技能提升：
- 认知升级：

### 生活状态
- 健康：
- 人际关系：
- 兴趣/休闲：

### 下月关注点
- 
- 
`;

// 生成文件并自动打开
await app.vault.create(fullPath, content);
const newFile = app.vault.getAbstractFileByPath(fullPath);
if (newFile) {
  await app.workspace.getLeaf(true).openFile(newFile);
  new Notice(`✅ ${config.monthStart} ~ ${config.monthEnd} 月记已生成并打开！`, 2000);
} else {
  new Notice(`❌ 月记文件创建成功，但无法打开`, 3000);
}
%>